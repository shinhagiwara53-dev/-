<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>運転手拘束時間管理(当日用)</title>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const startTimeInput = document.getElementById("startTime");
      const endTimeInput = document.getElementById("endTime");
      const nextDayStartTimeInput = document.getElementById("nextDayStartTime");
      const resultDisplay = document.getElementById("result");
      const warningDisplay = document.getElementById("warnings");

      // 初期値
      startTimeInput.value = "05:40";
      endTimeInput.value = "17:30";
      nextDayStartTimeInput.value = "02:10";

      function formatHoursToHHMM(decimalHours) {
        if (decimalHours === null) return null;
        const totalMinutes = Math.round(decimalHours * 60);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        return `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}`;
      }

      function calculateTimes() {
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        const nextDayStartTime = nextDayStartTimeInput.value;

        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        if (!timeRegex.test(startTime) || !timeRegex.test(endTime) || !timeRegex.test(nextDayStartTime)) {
          warningDisplay.textContent = "有効な時間を入力してください (例: 08:00)";
          resultDisplay.textContent = "";
          return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // 始業
        const [startHour, startMinute] = startTime.split(":").map(Number);
        const startDateTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), startHour, startMinute);

        // 終業
        const [endHour, endMinute] = endTime.split(":").map(Number);
        let endDateTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), endHour, endMinute);
        if (endDateTime.getTime() < startDateTime.getTime()) {
          endDateTime.setDate(endDateTime.getDate() + 1);
        }

        const shiftConstraintMillis = endDateTime.getTime() - startDateTime.getTime();
        const calculatedShiftConstraintHours = shiftConstraintMillis / (1000 * 60 * 60);

        // 翌日の出勤
        const [nextStartHour, nextStartMinute] = nextDayStartTime.split(":").map(Number);
        let nextDayStartDateTime = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, nextStartHour, nextStartMinute);
        if (nextDayStartDateTime.getTime() < endDateTime.getTime()) {
          nextDayStartDateTime.setDate(nextDayStartDateTime.getDate() + 1);
        }

        let effectiveConstraintHours = calculatedShiftConstraintHours;
        let doubleCountedHours = 0;

        const periodEnd24h = new Date(startDateTime.getTime() + 24 * 60 * 60 * 1000);
        if (nextDayStartDateTime.getTime() < periodEnd24h.getTime()) {
          const doubleCountedMillis = periodEnd24h.getTime() - nextDayStartDateTime.getTime();
          doubleCountedHours = doubleCountedMillis / (1000 * 60 * 60);
          effectiveConstraintHours += doubleCountedHours;
        }

        const displayConstraintTime = formatHoursToHHMM(effectiveConstraintHours);
        resultDisplay.innerHTML = `拘束時間: <span style="font-weight:bold; color:${effectiveConstraintHours > 15 ? "red" : "blue"}">${displayConstraintTime}</span>`;

        let warnings = [];
        if (doubleCountedHours > 0) {
          warnings.push(
            `警告: 始業から24時間以内に翌日の出勤が発生しています。\n` +
            `このため、翌日${nextDayStartTime} から 翌日${periodEnd24h.toLocaleTimeString("ja-JP", {hour:"2-digit", minute:"2-digit"})} までの ${formatHoursToHHMM(doubleCountedHours)} が拘束時間として加算されています。`
          );
        }
        if (effectiveConstraintHours > 15) {
          warnings.push(`警告: 総拘束時間（${formatHoursToHHMM(effectiveConstraintHours)}）が15時間を超えています！`);
        }
        warningDisplay.textContent = warnings.join("\n");
      }

      startTimeInput.addEventListener("input", calculateTimes);
      endTimeInput.addEventListener("input", calculateTimes);
      nextDayStartTimeInput.addEventListener("input", calculateTimes);

      calculateTimes(); // 初期計算
    });
  </script>
  <style>
    body { font-family: sans-serif; background: #f7f7f7; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .container { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 350px; }
    h1 { font-size: 20px; text-align: center; margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; }
    #result { margin: 15px 0; font-size: 16px; }
    #warnings { white-space: pre-line; color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>運転手拘束時間管理(当日用)</h1>
    <label for="startTime">始業時間 (HH:mm)</label>
    <input type="time" id="startTime">

    <label for="endTime">終了時間 (HH:mm)</label>
    <input type="time" id="endTime">

    <label for="nextDayStartTime">翌日の出勤時間 (HH:mm)</label>
    <input type="time" id="nextDayStartTime">

    <div id="result"></div>
    <div id="warnings"></div>
  </div>
</body>
</html>
