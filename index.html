<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>運転手1日の拘束時間管理アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex items-center justify-center bg-gray-100 p-4 font-inter">

  <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">運転手1日の拘束時間管理アプリ</h1>

    <!-- 始業日 -->
    <div class="mb-4">
      <label for="currentShiftDate" class="block text-gray-700 text-sm font-semibold mb-2">始業日</label>
      <input type="date" id="currentShiftDate" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
    </div>

    <!-- 始業時間 -->
    <div class="mb-4">
      <label for="startTime" class="block text-gray-700 text-sm font-semibold mb-2">始業時間 (HH:mm)</label>
      <input type="time" id="startTime" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
    </div>

    <!-- 終了日 -->
    <div class="mb-4">
      <label for="endDate" class="block text-gray-700 text-sm font-semibold mb-2">終了日</label>
      <input type="date" id="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
    </div>

    <!-- 終了時間 -->
    <div class="mb-4">
      <label for="endTime" class="block text-gray-700 text-sm font-semibold mb-2">終了時間 (HH:mm)</label>
      <input type="time" id="endTime" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
    </div>

    <!-- 次の出勤日 -->
    <div class="mb-4">
      <label for="nextShiftDate" class="block text-gray-700 text-sm font-semibold mb-2">次の出勤日</label>
      <input type="date" id="nextShiftDate" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
    </div>

    <!-- 次の出勤時間 -->
    <div class="mb-6">
      <label for="nextShiftTime" class="block text-gray-700 text-sm font-semibold mb-2">次の出勤時間 (HH:mm)</label>
      <input type="time" id="nextShiftTime" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
    </div>

    <!-- 計算結果 -->
    <div class="bg-gray-50 p-4 rounded-md mb-6 shadow-sm">
      <h2 class="text-xl font-bold text-gray-700 mb-2">計算結果</h2>
      <p id="constraintResult" class="text-gray-800 text-lg mb-1"></p>
    </div>

    <!-- 警告メッセージ -->
    <div id="warningMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative text-center shadow-md whitespace-pre-line mb-6"></div>
  </div>

  <script>
    const currentShiftDateEl = document.getElementById("currentShiftDate");
    const startTimeEl = document.getElementById("startTime");
    const endDateEl = document.getElementById("endDate");
    const endTimeEl = document.getElementById("endTime");
    const nextShiftDateEl = document.getElementById("nextShiftDate");
    const nextShiftTimeEl = document.getElementById("nextShiftTime");
    const resultEl = document.getElementById("constraintResult");
    const warningEl = document.getElementById("warningMessage");

    // 今日の日付
    const getTodayDateString = () => new Date().toISOString().split('T')[0];

    // 初期値設定
    currentShiftDateEl.value = getTodayDateString();
    endDateEl.value = getTodayDateString();
    nextShiftDateEl.value = getTodayDateString();
    startTimeEl.value = "05:00";
    endTimeEl.value = "14:00";
    nextShiftTimeEl.value = "23:00";

    function formatHoursToHHMM(decimalHours) {
      if (decimalHours === null) return null;
      const totalMinutes = Math.round(decimalHours * 60);
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
    }

    function calculateTimes() {
      const startDate = currentShiftDateEl.value;
      const startTime = startTimeEl.value;
      const endDate = endDateEl.value;
      const endTime = endTimeEl.value;
      const nextShiftDate = nextShiftDateEl.value;
      const nextShiftTime = nextShiftTimeEl.value;

      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
      if (!timeRegex.test(startTime) || !timeRegex.test(endTime) || !timeRegex.test(nextShiftTime)) {
        showWarning("有効な時間を入力してください (例: 08:00)");
        resultEl.textContent = "";
        return;
      }

      const startDateTime = new Date(`${startDate}T${startTime}:00`);
      const endDateTime = new Date(`${endDate}T${endTime}:00`);
      const nextShiftStartDateTime = new Date(`${nextShiftDate}T${nextShiftTime}:00`);

      let warnings = [];

      if (endDateTime < startDateTime) {
        warnings.push("警告: 終了日時が始業日時よりも前に設定されています。");
      }
      if (nextShiftStartDateTime < startDateTime) {
        warnings.push("警告: 次の出勤日時が現在の始業日時よりも前に設定されています。");
      }

      if (warnings.length > 0) {
        showWarning(warnings.join("\n"));
        resultEl.textContent = "";
        return;
      }

      const shiftMillis = endDateTime - startDateTime;
      const shiftHours = shiftMillis / (1000*60*60);

      let effectiveConstraintHours = shiftHours;
      let doubleCountedHours = 0;

      const periodEnd24h = new Date(startDateTime.getTime() + 24*60*60*1000);

      if (nextShiftStartDateTime < periodEnd24h) {
        const doubleCountedMillis = periodEnd24h - nextShiftStartDateTime;
        doubleCountedHours = doubleCountedMillis / (1000*60*60);
        effectiveConstraintHours += doubleCountedHours;
      }

      resultEl.innerHTML = `拘束時間: <span class="font-semibold ${effectiveConstraintHours > 15 ? 'text-red-700':'text-blue-700'}">${formatHoursToHHMM(effectiveConstraintHours)}</span>`;

      if (doubleCountedHours > 0) {
        warnings.push(`警告: 始業から24時間以内に次の出勤が発生しています。このため、${formatHoursToHHMM(doubleCountedHours)} が拘束時間として加算されています。`);
      }
      if (effectiveConstraintHours > 15) {
        warnings.push(`警告: 総拘束時間（${formatHoursToHHMM(effectiveConstraintHours)}）が15時間を超えています！`);
      }

      if (warnings.length > 0) {
        showWarning(warnings.join("\n"));
      } else {
        hideWarning();
      }
    }

    function showWarning(msg) {
      warningEl.textContent = msg;
      warningEl.classList.remove("hidden");
    }
    function hideWarning() {
      warningEl.classList.add("hidden");
    }

    // 入力が変わるたびに計算
    [currentShiftDateEl, startTimeEl, endDateEl, endTimeEl, nextShiftDateEl, nextShiftTimeEl].forEach(el=>{
      el.addEventListener("input", calculateTimes);
    });

    // 初回計算
    calculateTimes();
  </script>
</body>
</html>

